
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>ploomber.InMemoryDAG &#8212; ploomber 0.19.6 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom-theme.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/mermaid-style.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/mermaid-layout.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/custom.js"></script>
    <script src="../../../_static/js/mermaid.min.js"></script>
    <script src="../../../_static/js/terminal.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="ploomber.tasks.Task" href="../tasks/ploomber.tasks.Task.html" />
    <link rel="prev" title="ploomber.DAGConfigurator" href="ploomber.DAGConfigurator.html" />
 

<!-- Required meta tags -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<!-- Bootstrap CSS -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

<style>
    body {
        padding-top: 5rem;
    }

    /* make all images responsive (same as .img-fluid) */
    img {
        max-width: 100%;
        height: auto;
    }
</style>

<!-- Algolia -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3" />
</pre>
</link>

<!-- Below script for subscribe button in videos page-->
<script src="https://apis.google.com/js/platform.js"></script>
<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<!-- jQuery is loaded by sphinx anyway -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
    crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
    integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
    crossorigin="anonymous"></script>




  </head><body>



<nav class="navbar navbar-expand-md navbar-dark fixed-top">
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#first-column"
        aria-controls="first-column" aria-expanded="false" aria-label="Toggle TOC">
        <span class="navbar-toggler-icon"></span>
    </button>

    <a class="navbar-brand" href="../../../index.html">Ploomber</a>

    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#top-bar" aria-controls="top-bar"
        aria-expanded="false" aria-label="Toggle navigation">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-search"
            viewBox="0 0 16 16">
            <path
                d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z" />
        </svg>
    </button>

    <div class="collapse navbar-collapse" id="top-bar">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item  active ">
                <a class="nav-link" href="../../../index.html">Documentation
                </a>
            </li>
            <li class="nav-item ">
                <a class="nav-link" href="../../../cloud/cloud-execution.html">Cloud
                </a>
            </li>
            <li class="nav-item ">
                <a class="nav-link" href="../../../videos.html">Videos</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="https://github.com/ploomber/ploomber">GitHub</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="https://ploomber.io/community">Community</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="https://www.getrevue.co/profile/ploomber">Newsletter</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="https://ploomber.io">Blog</a>
            </li>
        </ul>

        <!-- By default any child element that uses Bootstrap nav class falls under display flex! -->
        <div class="flex-md-shrink-0" id="search">
            <!-- flex-md-shrink-0 is a responsive class inside boostrap flex class that shrinks elements as the width decreases!-->
            <form class="search form-inline my-2 my-lg-0" action="../../../search.html" method="get">
                <input class="form-control mr-sm-2" type="text" placeholder="Search" aria-label="Search" name="q">
                <button class="btn btn-secondary my-2 my-sm-0" type="submit">Search</button>
            </form>
        </div>

    </div>
</nav>



<div class="container-fluid">
    <div class="row">
        <div class="col-md-3 col-xl-2 first-column collapse" id="first-column">
            

<div class="global-toc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../get-started/index.html">Get Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../use-cases/index.html">Use Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user-guide/index.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cloud/index.html">Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../deployment/index.html">Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cookbook/index.html">Cookbook</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">API Reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../spec.html">Spec API (<code class="docutils literal notranslate"><span class="pre">pipeline.yaml</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cli.html">Command line interface</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../python_api.html">Python API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../testing.html">Testing utilities</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/index.html">Community</a></li>
</ul>
</div>

            <div class="help-tooltip">
                <p>Something not working? <a
                        href="https://github.com/ploomber/ploomber/issues/new?body=Documentation+page%3A+api%2F_modules%2Froot%2Fploomber.InMemoryDAG"
                        target="_blank" rel="noreferrer">Open an issue on
                        GitHub</a> or <a href="https://ploomber.io/community" target="_blank" rel="noreferrer">message
                        us on Slack.</a></p>
            </div>
        </div>
        <div class="col-md-9 col-xl-8">
            <div class="document">
                <div class="documentwrapper">
                    <div class="bodywrapper">
                        <div class="body" role="main">
                            
  <section id="ploomber-inmemorydag">
<h1>ploomber.InMemoryDAG<a class="headerlink" href="#ploomber-inmemorydag" title="Permalink to this headline">¶</a></h1>
<dl class="py class">
<dt class="sig sig-object py" id="ploomber.InMemoryDAG">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">ploomber.</span></span><span class="sig-name descname"><span class="pre">InMemoryDAG</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">dag</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">return_postprocessor</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#ploomber.InMemoryDAG" title="Permalink to this definition">¶</a></dt>
<dd><p>Converts a DAG to a DAG-like object that performs all operations in memory
(products are not serialized). For this to work all tasks must be
<code class="docutils literal notranslate"><span class="pre">PythonCallable</span></code> objects initialized with callables that return a value
with valid <code class="docutils literal notranslate"><span class="pre">serializer</span></code> and <code class="docutils literal notranslate"><span class="pre">unserializer</span></code> parameters.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>dag</strong> (<a class="reference internal" href="ploomber.DAG.html#ploomber.DAG" title="ploomber.DAG"><em>ploomber.DAG</em></a>) – The DAG to use</p>
</dd>
</dl>
<p class="rubric">Examples</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This example shows how to re-use the same feature engineering code in</span>
<span class="sd">both training (batch processing) and serving (online).</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">datasets</span>
<span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeClassifier</span>

<span class="kn">from</span> <span class="nn">ploomber</span> <span class="kn">import</span> <span class="n">DAG</span><span class="p">,</span> <span class="n">InMemoryDAG</span>
<span class="kn">from</span> <span class="nn">ploomber.tasks</span> <span class="kn">import</span> <span class="n">PythonCallable</span>
<span class="kn">from</span> <span class="nn">ploomber.products</span> <span class="kn">import</span> <span class="n">File</span>
<span class="kn">from</span> <span class="nn">ploomber.executors</span> <span class="kn">import</span> <span class="n">Serial</span>
<span class="kn">from</span> <span class="nn">ploomber.tasks</span> <span class="kn">import</span> <span class="n">input_data_passer</span><span class="p">,</span> <span class="n">in_memory_callable</span>


<span class="k">def</span> <span class="nf">get</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Get training data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">load_iris</span><span class="p">(</span><span class="n">as_frame</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">df</span>


<span class="c1"># NOTE: &quot;upstream&quot; is the output from the task that executes before this one</span>
<span class="k">def</span> <span class="nf">a_feature</span><span class="p">(</span><span class="n">upstream</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute one feature</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">upstream</span><span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;a_feature&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sepal length (cm)&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">})</span>


<span class="k">def</span> <span class="nf">another</span><span class="p">(</span><span class="n">upstream</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute another feature</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">upstream</span><span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;another&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sepal width (cm)&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">})</span>


<span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="n">upstream</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">upstream</span><span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">upstream</span><span class="p">[</span><span class="s1">&#39;a_feature&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">upstream</span><span class="p">[</span><span class="s1">&#39;another&#39;</span><span class="p">])</span>


<span class="c1"># NOTE: &quot;product&quot; is the model file output location</span>
<span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="n">product</span><span class="p">,</span> <span class="n">upstream</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Train a model and save it (pickle format)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">clf</span> <span class="o">=</span> <span class="n">DecisionTreeClassifier</span><span class="p">()</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">upstream</span><span class="p">[</span><span class="s1">&#39;join&#39;</span><span class="p">]))</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>
    <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">product</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>


<span class="c1"># NOTE: serializer and unserializer are special function that tell the pipeline</span>
<span class="c1"># how to convert the object returned by our tasks (pandas.DataFrame) to files.</span>
<span class="c1"># These are only required when we want to build a dag that works both in</span>
<span class="c1"># batch-processing and online mode</span>
<span class="k">def</span> <span class="nf">serializer</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">product</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Save all data frames as CSVs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">product</span><span class="p">)</span>

    <span class="c1"># make sure the parent folder exists</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">unserializer</span><span class="p">(</span><span class="n">product</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function to read CSVs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">product</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">add_features</span><span class="p">(</span><span class="n">dag</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a DAG, adds feature engineering tasks. The DAG must have a task &quot;get&quot;</span>
<span class="sd">    that returns the input data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">get_task</span> <span class="o">=</span> <span class="n">dag</span><span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">]</span>

    <span class="n">output</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">)</span>

    <span class="c1"># instantiate tasks</span>
    <span class="n">a_feature_task</span> <span class="o">=</span> <span class="n">PythonCallable</span><span class="p">(</span><span class="n">a_feature</span><span class="p">,</span>
                                    <span class="n">File</span><span class="p">(</span><span class="n">output</span> <span class="o">/</span> <span class="s1">&#39;a_feature.csv&#39;</span><span class="p">),</span>
                                    <span class="n">dag</span><span class="p">,</span>
                                    <span class="n">serializer</span><span class="o">=</span><span class="n">serializer</span><span class="p">,</span>
                                    <span class="n">unserializer</span><span class="o">=</span><span class="n">unserializer</span><span class="p">)</span>
    <span class="n">another_task</span> <span class="o">=</span> <span class="n">PythonCallable</span><span class="p">(</span><span class="n">another</span><span class="p">,</span>
                                  <span class="n">File</span><span class="p">(</span><span class="n">output</span> <span class="o">/</span> <span class="s1">&#39;another.csv&#39;</span><span class="p">),</span>
                                  <span class="n">dag</span><span class="p">,</span>
                                  <span class="n">serializer</span><span class="o">=</span><span class="n">serializer</span><span class="p">,</span>
                                  <span class="n">unserializer</span><span class="o">=</span><span class="n">unserializer</span><span class="p">)</span>
    <span class="n">join_task</span> <span class="o">=</span> <span class="n">PythonCallable</span><span class="p">(</span><span class="n">join</span><span class="p">,</span>
                               <span class="n">File</span><span class="p">(</span><span class="n">output</span> <span class="o">/</span> <span class="s1">&#39;join.csv&#39;</span><span class="p">),</span>
                               <span class="n">dag</span><span class="p">,</span>
                               <span class="n">serializer</span><span class="o">=</span><span class="n">serializer</span><span class="p">,</span>
                               <span class="n">unserializer</span><span class="o">=</span><span class="n">unserializer</span><span class="p">)</span>

    <span class="c1"># establish dependencies</span>
    <span class="n">get_task</span> <span class="o">&gt;&gt;</span> <span class="n">a_feature_task</span>
    <span class="n">get_task</span> <span class="o">&gt;&gt;</span> <span class="n">another_task</span>
    <span class="p">(</span><span class="n">get_task</span> <span class="o">+</span> <span class="n">a_feature_task</span> <span class="o">+</span> <span class="n">another_task</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">join_task</span>

    <span class="k">return</span> <span class="n">dag</span>


<span class="k">def</span> <span class="nf">make_training</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Instantiates the training DAG</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># setting build_in_subprocess=False because Python does not like when we</span>
    <span class="c1"># use multiprocessing in functions defined in the main module. Works if</span>
    <span class="c1"># we define them in a different one</span>
    <span class="n">dag</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">(</span><span class="n">executor</span><span class="o">=</span><span class="n">Serial</span><span class="p">(</span><span class="n">build_in_subprocess</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

    <span class="n">output</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">)</span>

    <span class="c1"># add &quot;get&quot; task that returns the training data</span>
    <span class="n">PythonCallable</span><span class="p">(</span><span class="n">get</span><span class="p">,</span>
                   <span class="n">File</span><span class="p">(</span><span class="n">output</span> <span class="o">/</span> <span class="s1">&#39;get.csv&#39;</span><span class="p">),</span>
                   <span class="n">dag</span><span class="p">,</span>
                   <span class="n">serializer</span><span class="o">=</span><span class="n">serializer</span><span class="p">,</span>
                   <span class="n">unserializer</span><span class="o">=</span><span class="n">unserializer</span><span class="p">)</span>

    <span class="c1"># add features tasks</span>
    <span class="n">add_features</span><span class="p">(</span><span class="n">dag</span><span class="p">)</span>

    <span class="c1"># add &quot;fit&quot; task for model training</span>
    <span class="n">fit_t</span> <span class="o">=</span> <span class="n">PythonCallable</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span> <span class="o">/</span> <span class="s1">&#39;model.pickle&#39;</span><span class="p">),</span> <span class="n">dag</span><span class="p">)</span>

    <span class="c1"># train after joining features</span>
    <span class="n">dag</span><span class="p">[</span><span class="s1">&#39;join&#39;</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">fit_t</span>

    <span class="k">return</span> <span class="n">dag</span>


<span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">upstream</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make a prediction after computing features</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">upstream</span><span class="p">[</span><span class="s1">&#39;join&#39;</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">validate_input_data</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate input data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;sepal length (cm)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sepal width (cm)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;petal length (cm)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;petal width (cm)&#39;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">!=</span> <span class="n">cols</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unexpected set of columns, expected: </span><span class="si">{</span><span class="n">cols</span><span class="si">!r}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">is_negative</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span>
    <span class="n">wrong_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">is_negative</span><span class="p">[</span><span class="n">is_negative</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">wrong_cols</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Column(s) </span><span class="si">{</span><span class="n">wrong_cols</span><span class="si">!r}</span><span class="s1"> have one or more invalid&#39;</span>
                         <span class="s1">&#39; (negative) observations&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span>


<span class="k">def</span> <span class="nf">make_predict</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Instantiate a prediction DAG using a previously trained model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dag_pred</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">()</span>

    <span class="c1"># this special function adds a task with name &quot;get&quot; that will just forward</span>
    <span class="c1"># whatever value we pass when calling .build(). You can pass a function</span>
    <span class="c1"># in the &quot;preprocessor&quot; argument to perform arbitrary logic like parsing</span>
    <span class="c1"># or validation</span>
    <span class="n">input_data_passer</span><span class="p">(</span><span class="n">dag</span><span class="o">=</span><span class="n">dag_pred</span><span class="p">,</span>
                      <span class="n">name</span><span class="o">=</span><span class="s1">&#39;get&#39;</span><span class="p">,</span>
                      <span class="n">preprocessor</span><span class="o">=</span><span class="n">validate_input_data</span><span class="p">)</span>

    <span class="c1"># we re-use the same code that we used for training!</span>
    <span class="n">add_features</span><span class="p">(</span><span class="n">dag_pred</span><span class="p">)</span>

    <span class="c1"># load model generated by the training graph</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;model.pickle&#39;</span><span class="p">),</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="c1"># add the final task, this special function just executes whatever</span>
    <span class="c1"># function we pass as the first argument, we can pass arbitrary parameters</span>
    <span class="c1"># using &quot;params&quot;</span>
    <span class="n">predict_task</span> <span class="o">=</span> <span class="n">in_memory_callable</span><span class="p">(</span><span class="n">predict</span><span class="p">,</span>
                                      <span class="n">dag</span><span class="o">=</span><span class="n">dag_pred</span><span class="p">,</span>
                                      <span class="n">name</span><span class="o">=</span><span class="s1">&#39;predict&#39;</span><span class="p">,</span>
                                      <span class="n">params</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">))</span>

    <span class="c1"># predict after joining features</span>
    <span class="n">dag_pred</span><span class="p">[</span><span class="s1">&#39;join&#39;</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">predict_task</span>

    <span class="c1"># convert our batch-processing pipeline to a in-memory one and return</span>
    <span class="k">return</span> <span class="n">InMemoryDAG</span><span class="p">(</span><span class="n">dag_pred</span><span class="p">)</span>


<span class="c1"># instantiate training pipeline</span>
<span class="n">dag</span> <span class="o">=</span> <span class="n">make_training</span><span class="p">()</span>
<span class="c1"># run it (generates model.pkl)</span>
<span class="n">dag</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>

<span class="c1"># instantiate prediction pipeline</span>
<span class="n">dag_pred</span> <span class="o">=</span> <span class="n">make_predict</span><span class="p">()</span>

<span class="c1"># input data: generates features from this and then feeds the model</span>
<span class="n">sample_input</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;sepal length (cm)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.9</span><span class="p">],</span>
    <span class="s1">&#39;sepal width (cm)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">],</span>
    <span class="s1">&#39;petal length (cm)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.1</span><span class="p">],</span>
    <span class="s1">&#39;petal width (cm)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.8</span><span class="p">]</span>
<span class="p">})</span>

<span class="c1"># pass input data through the prediction pipeline. A pipeline might have</span>
<span class="c1"># multiple inputs, in our case it only has one. The format is:</span>
<span class="c1"># {task_name: input_data}</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">dag_pred</span><span class="o">.</span><span class="n">build</span><span class="p">({</span><span class="s1">&#39;get&#39;</span><span class="p">:</span> <span class="n">sample_input</span><span class="p">})</span>

<span class="c1"># result is a dictionary with {task_name: output}. Get the output from the</span>
<span class="c1"># predict task</span>
<span class="n">result</span><span class="p">[</span><span class="s1">&#39;predict&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p class="rubric">Methods</p>
<table class="autosummary longtable docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><a class="reference internal" href="#ploomber.InMemoryDAG.build" title="ploomber.InMemoryDAG.build"><code class="xref py py-obj docutils literal notranslate"><span class="pre">build</span></code></a>(input_data[, copy])</p></td>
<td><p>Run the DAG</p></td>
</tr>
</tbody>
</table>
<dl class="py method">
<dt class="sig sig-object py" id="ploomber.InMemoryDAG.build">
<span class="sig-name descname"><span class="pre">build</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">input_data</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">copy</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#ploomber.InMemoryDAG.build" title="Permalink to this definition">¶</a></dt>
<dd><p>Run the DAG</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>input_data</strong> (<em>dict</em>) – A dictionary mapping root tasks (names) to dict params. Root tasks
are tasks in the DAG that do not have upstream dependencies,
the corresponding dictionary is passed to the respective task
source function as keyword arguments</p></li>
<li><p><strong>copy</strong> (<em>bool</em><em> or </em><em>callable</em>) – Whether to copy the output of an upstream task before passing it
to the task being processed. It is recommended to turn this off
for memory efficiency but if the tasks are not pure functions
(i.e. mutate their inputs) this migh lead to bugs, in such
case, the best way to fix it would be to make all your tasks
pure functions but you can enable this option if memory
consumption is not a problem. If True it uses the <code class="docutils literal notranslate"><span class="pre">copy.copy</span></code>
function before passing the upstream products, if you pass a
callable instead, such function is used (for example, you
may pass <code class="docutils literal notranslate"><span class="pre">copy.deepcopy</span></code>)</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>A dictionary mapping task names to their respective outputs</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>dict</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

</section>


                            <div class="clearer"></div>
                        </div>
                    </div>
                </div>
                <div class="clearer"></div>
            </div>
        </div>
        <div class="d-none d-xl-block col-xl-2 third-column">
            
<div class="sphinxsidebar" role="navigation" aria-label="main navigation">
    <div class="sphinxsidebarwrapper">
    </div>
</div>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3"></script>

<script type="text/javascript">
    docsearch({
        appId: 'Y6L7HQ2HZO',
        apiKey: 'a44b754f3d890a27dcbd9b4f860fea6b',
        indexName: 'ploomber',
        container: '#search',
        debug: false

    });
</script>
<div class="footer" role="contentinfo">
</div>
  </body>
</html>